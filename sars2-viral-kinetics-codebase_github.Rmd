---
title: "SARS-2 viral kinetics"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r setup}
library(tidyverse)
library(deSolve)
library(mlxR)
```

# Load simulated treatments
```{r}
hcq.gautret.lim2009.sim.typical <- read.csv("hcq.gautret.lim2009.sim.typical.csv")
hcq.who.lim2009.sim.typical <- read.csv("hcq.who.lim2009.sim.typical.csv")
covid.sim.ivmfood.3x600.typical <- read.csv("covid.sim.ivmfood.3x600.typical.csv")
covid.sim.ivmfood.3x300.typical <- read.csv("covid.sim.ivmfood.3x300.typical.csv")
lpvrtv.dickinson2011.sim.typical <- read.csv("lpvrtv.dickinson2011.sim.typical.csv")
ntz1200.balderas2011.sim.typical <- read.csv("ntz1200.balderas2011.sim.typical.csv")
ntz2900.balderas2011.sim.typical <- read.csv("ntz2900.balderas2011.sim.typical.csv")
art.birgersson.exp.typical <- read.csv("art.birgersson.exp.typical.csv")
```

# Setup
## Conversions
The viral kinetics models predict absolute viral loads. The authors reported the cycle threshold (Ct) value from real time polymerase chain reaction (rtPCR) assays. As these vary by laboratory and analytical conditions, we chose to correlate model output with observed Ct values with a regression model described by Chou et al., Clin Chem. 2020; 66: 549-555): Ct(load [log10]) = -3.502*load + 40.55

```{r}
Ct_viral_load <- function( Ct, viral_load ) {
  if( missing(Ct) )
    return (-3.502*viral_load+40.55)
  
  return( (Ct-40.55)/-3.502 )
}

Ct_viral_load( viral_load=3.0 )
Ct_viral_load( Ct=30 )
```

Positivity in rtPCR was set to a Ct value of 35.
```{r}
CT_LIMIT_OF_DETECTION <- 35
```

## Immunity
The response often follows a sigmoidal curve, similar to an Emax model. For example, anti-spike protein (RBD) IgG titres measured by [To et al., 2020](doi:10.1016/S1473-3099(20)30196-1) reach half-maximal levels after about 14 days.

### To et al., Lancet 2020
```{r echo=F}
IgG_RBD_To_EC50 <- 12
IgG_RBD_To_Emax <- 2.1
IgG_RBD_To_Hill <- 8
IgG_RBD_To_max_eps <- 42
IgG_RBD_response <- data.frame( days = 0:60,
                  IgG_RBD = ((0:60)^IgG_RBD_To_Hill)/(IgG_RBD_To_EC50^IgG_RBD_To_Hill+(0:60)^IgG_RBD_To_Hill))
```

### Long et al., Nat Med 2020
VS fit to seroconversion profiles (Long, Q., Liu, B., Deng, H. et al. Antibody responses to SARS-CoV-2 in patients with COVID-19. Nat Med 26, 845–848 (2020). https://doi.org/10.1038/s41591-020-0897-1)
```{r}
IgG_Long_EC50 <- 10.2 
IgG_Long_Emax <- 104.6 
IgG_Long_Hill <- 3.4
IgG_Long_max_eps <- 52
IgG_Long_response <- data.frame( days = 0:60,
                  IgG_Long = ((0:60)^IgG_Long_Hill)/(IgG_Long_EC50^IgG_Long_Hill+(0:60)^IgG_Long_Hill))
```

### Comparison of the two curves
```{r}
ggplot(IgG_Long_response %>% filter(days<40), aes(days, IgG_Long_Emax*IgG_Long) ) +
  geom_line( data=IgG_Long_response %>% filter(days<40), aes(days, IgG_Long_Emax*IgG_Long, color="Seroconv. (Long, 2020)" )) + 
  geom_line( data=IgG_RBD_response %>% filter(days<40), aes(days, IgG_Long_Emax*IgG_RBD, color="IgG RBD (To, 2020") ) +
  labs( title="Immune response",
        colour="Source",
        x="Time [d]",
        y="Converted [%]") +
  theme_minimal()
```

# PK models

## HCQ
Lim et al. (Antimicrobial Agents and Chemotherapy Mar 2009, 53 (4) 1468-1475; DOI: 10.1128/AAC.00339-08)

```{r echo=F}
hcq.lim2009.model <- inlineModel("
[INDIVIDUAL]
input = { Tlag_pop, ka_pop, Cl_pop, V1_pop, Q_pop, V2_pop,
          Tlag_sd, ka_sd, Cl_sd, V1_sd, Q_sd, V2_sd,
          prop, add,
          WT }

EQUATION:
covWT = log(WT) - 4.248495 ; centered on log(70)

DEFINITION:
Tlag  = { distribution=lognormal, typical=Tlag_pop,   sd=Tlag_sd }
Cl  =   { distribution=lognormal, typical=Cl_pop,     sd=Cl_sd }
V1  =   { distribution=lognormal, typical=V1_pop,     sd=V1_sd }
V2  =   { distribution=lognormal, typical=V2_pop,     sd=V2_sd }
Q  =    { distribution=lognormal, typical=Q_pop,      sd=Q_sd }
ka  =   { distribution=lognormal, typical=ka_pop,     sd=ka_sd }

[LONGITUDINAL]
input = {Tlag, ka, Cl, V1, Q, V2, add, prop}

EQUATION:
; Parameter transformations 
V = V1 
k = Cl/V1 
k12 = Q/V1 
k21 = Q/V2

; PK model definition
Cc = pkmodel(Tlag, ka, V, k, k12, k21)

OUTPUT:
output = {Cc, y}

DEFINITION:
y = {distribution=normal, prediction=Cc, errorModel=combined1(add, prop)}
")

HCQ_MW <- 433.95

HCQ_spike_EC50_Liu <- 8.51 
HCQ_unbound_fraction <- 0.5 #50% of drug is bound to protein
```

## IVM
Duthaler et al., J Antimicrob Chemother. 2020 Feb 1;75(2):438-440.
doi: 10.1093/jac/dkz466

```{r echo=F}
ivmfood.model <- inlineModel("
[INDIVIDUAL]
input = { NN_pop, Mtt_pop, ka_pop, Cl_pop, V1_pop, Q_pop, V2_pop, F1_pop,
          NN_sd, Mtt_sd, ka_sd, Cl_sd, V1_sd, Q_sd, V2_sd,
          prop, add,
          WT }

EQUATION:
covWT = log(WT) - 4.248495 ; centered on log(70)
F1 = F1_pop

DEFINITION:
NN  = { distribution=lognormal, typical=NN_pop,   sd=NN_sd }
Mtt = { distribution=lognormal, typical=Mtt_pop,  sd=Mtt_sd }
ka  = { distribution=lognormal, typical=ka_pop,   sd=ka_sd }
Cl  = { distribution=lognormal, typical=Cl_pop,   sd=Cl_sd,   covariate=covWT,  coefficient=0.75 }
V1  = { distribution=lognormal, typical=V1_pop,   sd=V1_sd,   covariate=covWT,  coefficient=1 }
Q   = { distribution=lognormal, typical=Q_pop,    sd=Q_sd }
V2  = { distribution=lognormal, typical=V2_pop,   sd=V2_sd }

[LONGITUDINAL]
input = { NN, Mtt, ka, Cl, V1, Q, V2, F1, prop, add, WT}

EQUATION:
odeType = stiff
ddt_AUC = 1/V1 * Ac

; Parameter transformations 
Ktr = (NN+1)/Mtt
V = V1 
k = Cl/V1 
k12 = Q/V1 
k21 = Q/V2

; PK model definition
PK:
compartment(cmt=1, amount=Ac, volume=V)
peripheral( k12, k21 )
elimination( k )
oral( cmt=1, ka, Mtt, Ktr, p=F1 )
Cc = Ac / V

OUTPUT:
output = {Cc, y, AUC, WT}

DEFINITION:
y = {distribution=normal, prediction=Cc, errorModel=combined1(add, prop)}
")

IVM_MW <- 875.1 # g/mol, for conversion to uM

LUNG_ACCUMULATION <- 2.6 # cattle lung accumulation, Ref: Lifschitz
IVM_unbound_fraction <- (1-0.93) #93% of drug is protein bound

nAChR_IC50_uM <- 156 / 1000 
nAChR_Hill <- 1 

# Helicase inhibition
# Ref: J Antimicrob Chemother. 2012 Aug;67(8):1884-94.
# doi: 10.1093/jac/dks147. Epub 2012 Apr 25. https://pubmed.ncbi.nlm.nih.gov/22535622/
YFV_IC50_uM <- 0.12 # +/- 0.01
DENV_IC50_uM <- 0.5 # +/- 0.07
WNV_IC50_uM <- 0.35 # +/- 0.04
HELICASE_IC50_uM <- 0.1
```


## LPV/RTV
Dickinson L, Boffito M, Back D, et al. Sequential population pharmacokinetic modeling of lopinavir and ritonavir in healthy volunteers and assessment of different dosing strategies. Antimicrob Agents Chemother. 2011;55(6):2775-2782. doi:10.1128/AAC.00887-10

```{r echo=F}
lpvrtv.dickinson2011.model <- inlineModel("
[INDIVIDUAL]
input = {Tlag_pop, ka_pop, Cl_pop, V_pop,
         Tlag_sd, ka_sd, Cl_sd, V_sd,
         prop, add,
         WT}

DEFINITION:
Tlag = {distribution=lognormal, typical=Tlag_pop, sd=Tlag_sd}
ka =   {distribution=lognormal, typical=ka_pop,   sd=ka_sd}
Cl =   {distribution=lognormal, typical=Cl_pop,   sd=Cl_sd}
V =    {distribution=lognormal, typical=V_pop,    sd=V_sd}

[LONGITUDINAL]
input = {Tlag, ka, Cl, V, add, prop}

EQUATION:
; Parameter transformations 
k = Cl/V

; PK model definition
Cc = pkmodel(Tlag, ka, V, k)

OUTPUT:
output = {Cc}
")

LOP_MW <- 628.81 # g/mol, for conversion to uM

LUNG_ACCUMULATION <- 1.78
LOP_unbound_fraction <- (1-0.99)

Protease_IC50_uM <- 26.63 #uM 
Protease_Hill <- 1
```

## NTZ
```{r echo=F}
ntz.balderas2011.model <- inlineModel("
[INDIVIDUAL]
input = {Tlag_pop, ka_pop, Cl_pop, V_pop,
         Tlag_sd, ka_sd, Cl_sd, V_sd,
         WT}

DEFINITION:
Tlag = {distribution=lognormal, typical=Tlag_pop, sd=Tlag_sd}
ka =   {distribution=lognormal, typical=ka_pop,   sd=ka_sd}
Cl =   {distribution=lognormal, typical=Cl_pop,   sd=Cl_sd}
V =    {distribution=lognormal, typical=V_pop,    sd=V_sd}


[LONGITUDINAL]
input = {Tlag, ka, Cl, V}

EQUATION:
; Parameter transformations 
k = Cl/V

; PK model definition
Cc = pkmodel(Tlag, ka, V, k)

OUTPUT:
output = {Cc}
")

TZ_MW <- 265.25 # g/mol, for conversion to uM

LUNG_ACCUMULATION <- 0.7

TZ_unbound_fraction <- (1-0.99) 

Repl_IC50_uM <- 2.12 #uM 
Protease_Hill <- 1
```


## ART
Malar J. 2016 Feb 16;15:90. doi: 10.1186/s12936-016-1134-8.
Population pharmacokinetic properties of artemisinin in healthy male Vietnamese volunteers
Sofia Birgersson, Pham Van Toi, Nguyen Thanh Truong, Nguyen Thi Dung, Michael Ashton, Tran Tinh Hien, Angela Abelö, Joel Tarning
PMID: 26879816 PMCID: PMC4754918 DOI: 10.1186/s12936-016-1134-8 
    
```{r}
art.birgersson.model <- inlineModel( "
[LONGITUDINAL]
input = {Ktr, Mtt, V, Cl}

EQUATION:
odeType = stiff
ka = Ktr

; PK model definition
Cc = pkmodel(Ktr, Mtt, ka, V, Cl)

OUTPUT:
output = Cc")

ART_MW <- 282.336 # g/mol

ART1_EC50 <- 34 # ug/ml 
ART1_EC50_uM <- 120.4239 

ART_unbound_fraction <- (1-0.88) #88% of drug is protein bound, Sidhu et al., 1997
```

# Viral kinetics
## Model definitions
```{r}
TIME_POSITIVITY <- 5.4*24 # days post infection
TIME_PRESENTATION <- 10.2*24 # days post infection

get_ode_states_parameters <- function( immune_response="RBD_To" ) { 
  c <- 5.07 # virus clearance
  delta <- 0.54 # cell death
  p <- 10.18 # viral production rate
  I0 <- 0 # number of infected cells
  T0 <- 1*10**5 # number of target cells
  R0 <- 3.79 # within-host reproduction number
  V0 <- 1 # initial load (inoculum)
  
  Immune_EC50 <- IgG_RBD_To_EC50 # days
  Immune_Hill <- IgG_RBD_To_Hill # Hill coefficient
  Immune_Emax <- IgG_RBD_To_max_eps # maximum effect on viral clearance
  
  if( immune_response == "Sero_Long" ) {
    Immune_EC50 <- IgG_Long_EC50 # days
    Immune_Hill <- IgG_Long_Hill # Hill coefficient
    Immune_Emax <- IgG_Long_max_eps # maximum effect on viral clearance    
  }
  
  beta <- c *delta*R0/((p-delta*R0)*T0)

  # ODE system parameterization
  parameters <- c( c=c,
                   delta=delta,
                   p=p,
                   R0=R0,
                   beta=beta,
                   T0 = T0,
                   Immune_EC50=Immune_EC50,
                   Immune_Emax=Immune_Emax,
                   Immune_Hill=Immune_Hill)
  
  # ODE system initial conditions
  state <- c( Tf = T0, # target cells
              If = I0, # infected cells
              Vf = V0 ) # viral load
  
  return( list(state=state, parameters=parameters))
} 

get_ode_states_parameters()
get_ode_states_parameters("RBD_To")
get_ode_states_parameters("Sero_Long")
```

```{r echo=F}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# model
sars2_noeclipse <- function( t, state, parameters ) {  # function of time, state, parameters
  with(as.list(c(state, parameters)),{ 
    # rate of change
    eps_inf <- input_inf(t)
    eps_repro <- input_repro(t)
    eps_acquired <- Immune_Emax * (t^Immune_Hill)/(Immune_EC50^Immune_Hill+t^Immune_Hill)
    beta <- c*(1+eps_acquired)*delta*R0/((p-delta*R0)*T0)
    
    dTf <-  - beta*(1-eps_inf)*Tf*Vf
    dIf <-  + beta*(1-eps_inf)*Tf*Vf - delta*If
    dVf <-  + p*(1-eps_repro)*If - c*(1+eps_acquired)*Vf - beta*(1-eps_inf)*Tf*Vf
    # return rate of change
    list(c(dTf, dIf, dVf))
    })
}

# Immunity model according to Long
ode_settings <- get_ode_states_parameters("Sero_Long")

df.immunity.long <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="immune response (Long 2020)")

ggplot( df.immunity.long %>% filter(time<30), aes(time, Ct)) +
  geom_hline( yintercept = CT_LIMIT_OF_DETECTION, linetype="dotted", color="black", size=1 ) +
  geom_line(size=1) +
  scale_y_continuous( breaks=(0:10)*5, trans="reverse") +
  labs( color="",
        linetype="",
        x="Days post infection (dpi) [d]",
        y="Ct") + 
  theme_minimal() +
  theme( legend.position = "bottom")
```

## HCQ
### Gautret et al.
#### Dosing on positivity
```{r echo=F}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# Gautret treatment effect
df <- hcq.gautret.lim2009.sim.typical %>% 
  dplyr::select(-X)  %>%
  dplyr::mutate( time = time + TIME_POSITIVITY ) 
  

df <- rbind( data.frame( time=0,
                         eps_unbound_liu=0 ),
             df ) 
input_inf <- approxfun( df$time/24, df$eps_unbound_liu) # effect of infectivity suppression

df.gautret.on_positivity.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="HCQ Gautret, treated on positivity")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.gautret.on_positivity.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on positivity, HCQ 200 mg q8h (10d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

#### Dosing on presentation
```{r echo=F}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# Gautret treatment effect
df <- hcq.gautret.lim2009.sim.typical %>% 
  dplyr::select(-X) %>% 
  dplyr::mutate( time = time + TIME_PRESENTATION )
  
df <- rbind( data.frame( time=0,
                         eps_unbound_liu=0),
             df ) 
input_inf <- approxfun( df$time/24, df$eps_unbound_liu) # effect of infectivity suppression

df.gautret.on_presentation.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="HCQ Gautret, treated on presentation")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.gautret.on_presentation.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line(size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on presentation, HCQ 200 mg q8h (10d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

### WHO Solidarity
#### Dosing on positivity
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# WHO treatment effect
df <- hcq.who.lim2009.sim.typical %>% 
  dplyr::select(-X) %>% 
  mutate( time = time + TIME_POSITIVITY ) # shift right by 5d  


df <- rbind( data.frame( time=0,
                         eps_unbound_liu=0),
             df ) 
input_inf <- approxfun( df$time/24, df$eps_unbound_liu) # effect of infectivity suppression

df.who.on_positivity.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="HCQ WHO, treated on positivity")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.who.on_positivity.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on positivity, HCQ 800 mg q12h (1d), 400 mg q12h (9d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

#### Dosing on presentation
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# WHO treatment effect
df <- hcq.who.lim2009.sim.typical %>% 
  dplyr::select(-X) %>% 
  mutate( time = time + TIME_PRESENTATION ) # shift right by 5d   


df <- rbind( data.frame( time=0,
                         eps_unbound_liu=0),
             df ) 
input_inf <- approxfun( df$time/24, df$eps_unbound_liu) # effect of infectivity suppression

df.who.on_presentation.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="HCQ WHO, treated on presentation")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.who.on_presentation.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on presentation, HCQ 800 mg q12h (1d), 400 mg q12h (9d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```


## IVM
### 3x300
#### Dosing on positivity
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# 3x300 treatment effect
df <- covid.sim.ivmfood.3x300.typical %>% 
  mutate( time = time + TIME_POSITIVITY ) %>% # shift right by 5d   
  dplyr::select(-X)

df <- rbind( data.frame( time=0,
                         eps_nAChR_unbound=0,
                         eps_helicase_unbound=0),
             df ) 
input_repro <- approxfun( df$time/24, df$eps_helicase_unbound) # effect of helicase suppression
input_inf <- approxfun( df$time/24, df$eps_nAChR_unbound) # effect of infectivity suppression

df.3x300.on_positivity.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="IVM 3x300, treated on positivity")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.3x300.on_positivity.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on positivity, IVM 300 ug/kg q24h (3d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

#### Dosing on presentation
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# 3x300 treatment effect
df <- covid.sim.ivmfood.3x300.typical %>% 
  mutate( time = time + TIME_PRESENTATION ) %>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0, 
                         eps_nAChR_unbound=0,
                         eps_helicase_unbound=0),
             df )
input_repro <- approxfun( df$time/24, df$eps_helicase_unbound) # effect of helicase suppression
input_inf <- approxfun( df$time/24, df$eps_nAChR_unbound) # effect of infectivity suppression

df.3x300.on_presentation.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="IVM 3x300, treated on presentation")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.3x300.on_presentation.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on presentation, IVM 300 ug/kg q24h (3d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

### 3x600
#### Dosing on positivity
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# 3x600 treatment effect
df <- covid.sim.ivmfood.3x600.typical %>% 
  mutate( time = time + TIME_POSITIVITY )%>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0,
                         eps_nAChR_unbound=0,
                         eps_helicase_unbound=0),
             df )
input_repro <- approxfun( df$time/24, df$eps_helicase_unbound) # effect of helicase suppression
input_inf <- approxfun( df$time/24, df$eps_nAChR_unbound) # effect of infectivity suppression

df.3x600.on_positivity.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="IVM 3x600, treated on positivity")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.3x600.on_positivity.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on positivity, IVM 600 ug/kg q24h (3d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

#### Dosing on presentation
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_inf <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# 3x600 treatment effect
df <- covid.sim.ivmfood.3x600.typical %>% 
  mutate( time = time + TIME_PRESENTATION ) %>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0, #add rows with zeros
                         eps_nAChR_unbound=0,
                         eps_helicase_unbound=0),
             df )
input_repro <- approxfun( df$time/24, df$eps_helicase_unbound) # effect of helicase suppression
input_inf <- approxfun( df$time/24, df$eps_nAChR_unbound) # effect of infectivity suppression

df.3x600.on_presentation.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="IVM 3x600, treated on presentation")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.3x600.on_presentation.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on presentation, IVM 600 ug/kg q24h (3d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

## LPV/RTV
#### Dosing on positivity
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_repro <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# lpvrtv treatment effect
df <- lpvrtv.dickinson2011.sim.typical %>% 
  mutate( time = time + TIME_POSITIVITY ) %>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0, 
                         eps_protease_unbound=0),
             df ) 


input_inf <- approxfun( df$time/24, df$eps_protease_unbound) # effect of infectivity suppression

df.lpvrtv.on_positivity.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="LPV/r, treated on positivity")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.lpvrtv.on_positivity.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on positivity, Lopinavir/ritonavir 400/100 mg q12h (14d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

#### Dosing on presentation
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_repro <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# lpvrtv treatment effect
df <- lpvrtv.dickinson2011.sim.typical %>% 
  mutate( time = time + TIME_PRESENTATION ) %>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0, 
                         eps_protease_unbound=0),
             df ) 
input_inf <- approxfun( df$time/24, df$eps_protease_unbound) # effect of infectivity suppression

df.lpvrtv.on_presentation.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="LPV/r, treated on presentation")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.lpvrtv.on_presentation.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on presentation, Lopinavir/ritonavir 400/100 mg q12h (14d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

## NTZ
### 1200 mg
#### Dosing on positivity
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_repro <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# NTZ treatment effect
df <- ntz1200.balderas2011.sim.typical %>% 
  mutate( time = time + TIME_POSITIVITY )%>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0, 
                         eps_repl_unbound=0),
             df ) 


input_inf <- approxfun( df$time/24, df$eps_repl_unbound ) # effect of infectivity suppression

df.ntz1200.on_positivity.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="NTZ 1200mg, treated on positivity")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.ntz1200.on_positivity.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on positivity, Nitazoxanide 1200 mg q6h (5d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

#### Dosing on presentation
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_repro <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# NTZ treatment effect
df <- ntz1200.balderas2011.sim.typical %>% 
  mutate( time = time + TIME_PRESENTATION ) %>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0, 
                         eps_repl_unbound=0),
             df ) 

input_repro <- approxfun( df$time/24, df$eps_repl_unbound ) # effect of infectivity suppression
input_inf <- approxfun( df$time/24, df$eps_repl_unbound ) # effect of infectivity suppression

df.ntz1200.on_presentation.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="NTZ 1200mg, treated on presentation")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.ntz1200.on_presentation.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on presentation, Nitazoxanide 1200 mg q6h (5d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

### 2900 mg
#### Dosing on positivity
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_repro <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# NTZ treatment effect
df <- ntz2900.balderas2011.sim.typical %>% 
  mutate( time = time + TIME_POSITIVITY )%>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0, 
                         eps_repl_unbound=0),
             df ) 


input_inf <- approxfun( df$time/24, df$eps_repl_unbound) # effect of infectivity suppression

df.ntz2900.on_positivity.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="NTZ 2900mg, treated on positivity")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.ntz2900.on_positivity.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on positivity, Nitazoxanide 2900 mg q12h (5d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

#### Dosing on presentation
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_repro <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# TZ treatment effect
df <- ntz2900.balderas2011.sim.typical %>% 
  mutate( time = time + TIME_PRESENTATION ) %>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0, 
                         eps_repl_unbound=0),
             df ) 
input_inf <- approxfun( df$time/24, df$eps_repl_unbound) # effect of infectivity suppression

df.ntz2900.on_presentation.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="NTZ 2900mg, treated on presentation")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.ntz2900.on_presentation.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on presentation, Nitazoxanide 2900 mg q12h (5d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```


## ART
### Dosing on positivity
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_repro <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# ART treatment effect
df <- art.birgersson.exp.typical %>% 
  mutate( time = time + TIME_POSITIVITY ) %>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0,
                         eps_art1_unbound=0),
             df )

input_inf <- approxfun( df$time/24, df$eps_art1_unbound) # effect of infectivity suppression

df.art.on_positivity.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="ART 500 mg, treated on positivity")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.art.on_positivity.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on positivity, Artemisinin 500 mg qd (5d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```

### Dosing on presentation
```{r}
ode_settings <- get_ode_states_parameters(immune_response = "Sero_Long")

times <- seq(0, 40, # number of days
             by = .1) 

input_repro <- input_cl <- input_repro <- function(x) return(0) # set all effects to 0 at any time

# ART treatment effect
df <- art.birgersson.exp.typical %>% 
  mutate( time = time + TIME_PRESENTATION ) %>%# shift right by 5d
  dplyr::select(-X)

df <- rbind( data.frame( time=0,
                         eps_art1_unbound=0),
             df )

input_inf <- approxfun( df$time/24, df$eps_art1_unbound) # effect of infectivity suppression

df.art.on_presentation.immunity <- ode(y = ode_settings$state, 
           times = times, 
           func = sars2_noeclipse, 
           parms = ode_settings$parameters) %>% 
  as.data.frame() %>% 
  mutate( Ct = Ct_viral_load( viral_load=log(Vf,base=10) ),
          group="ART 500 mg, treated on presentation")

ggplot( rbind(df.immunity.long %>% mutate(group="untreated"), 
              df.art.on_presentation.immunity) %>% 
          filter( time<25), aes(time, Ct, group=group, color=group)) +
  geom_line( size=1) + 
  scale_y_reverse() +
  geom_hline( yintercept = 35, linetype="dashed", color="black") +
  labs( title= "Within-host dynamics of SARS-CoV-2",
        subtitle = "Dosing on presentation, Artemisinin 500 mg qd (5d)",
        x="Days post infection [dpi]",
        y="Viral load [Ct]") +
  theme_minimal()
```